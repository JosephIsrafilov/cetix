{% extends "base.html" %}
{% load humanize %}

{% block title %}{{ article.title }} - Cetix{% endblock %}

{% block content %}
<article class="card article-detail">
    <div class="detail-header">
        <h1>{{ article.title }}</h1>
        <div class="meta detail-meta">
            <a href="{% url 'articles:author_detail' article.author.username %}">u/{{ article.author.username }}</a>
            <span class="meta-divider">&middot;</span>
            {% with stamp=article.published_at|default:article.created_at %}
                <time datetime="{{ stamp|date:"c" }}" title="{{ stamp|date:"M j, Y H:i" }}">
                    {{ stamp|naturaltime }}
                </time>
            {% endwith %}
            <span class="meta-divider">&middot;</span>
            <a class="badge" href="{% url 'articles:category_detail' article.category.slug %}">{{ article.category.name }}</a>
        </div>
    </div>
    {% if article.status != article.STATUS_PUBLISHED %}
        <div class="inline-note warning">
            Status: {{ article.get_status_display }}. Not visible publicly until moderation finishes.
        </div>
    {% endif %}
    {% with cover=article.get_cover_url %}
        {% if cover %}
            <div class="cover-frame">
                <img class="article-cover" src="{{ cover }}" alt="{{ article.title }}">
            </div>
        {% endif %}
    {% endwith %}
    <div class="article-content">
        {{ article.content|linebreaks }}
    </div>
    {% if user.is_authenticated and can_edit %}
        <div class="article-actions">
            <a class="button secondary" href="{% url 'articles:article_update' article.slug %}">Edit article</a>
            <a class="button danger" href="{% url 'articles:article_delete' article.slug %}">Delete article</a>
        </div>
    {% endif %}
</article>

<section id="engage" class="card engage-card">
    <h3>Engage with this article</h3>
    <div class="stats-row rating-summary" data-article-stats="{{ article.slug }}">
        <span class="stat-chip" data-stat="score"><strong>{{ article.score }}</strong> score</span>
        <span class="stat-chip" data-stat="likes"><strong>{{ article.likes_count }}</strong> upvotes</span>
        <span class="stat-chip" data-stat="dislikes"><strong>{{ article.dislikes_count }}</strong> downvotes</span>
        <span class="stat-chip" data-stat="comments"><strong>{{ comments_count }}</strong> comments</span>
    </div>
    {% if user.is_authenticated %}
        <div class="article-actions" data-reaction-group>
            <form class="reaction-form" data-article="{{ article.slug }}" data-reaction="like" method="post" action="{% url 'articles:toggle_reaction' article.slug 'like' %}">
                {% csrf_token %}
                <button type="submit" class="button {% if user_reaction and user_reaction.value == 'like' %}active{% endif %}">Like</button>
            </form>
            <form class="reaction-form" data-article="{{ article.slug }}" data-reaction="dislike" method="post" action="{% url 'articles:toggle_reaction' article.slug 'dislike' %}">
                {% csrf_token %}
                <button type="submit" class="button {% if user_reaction and user_reaction.value == 'dislike' %}active{% endif %}">Dislike</button>
            </form>
            <form method="post" action="{% url 'articles:toggle_bookmark' article.slug %}">
                {% csrf_token %}
                <button type="submit" class="button secondary">
                    {% if is_bookmarked %}Remove bookmark{% else %}Add bookmark{% endif %}
                </button>
            </form>
        </div>
        <form class="comment-form" method="post" action="{% url 'articles:comment_create' article.slug %}">
            {% csrf_token %}
            {{ comment_form.body }}
            {{ comment_form.parent_id }}
            <button type="submit" class="button primary">Post comment</button>
        </form>
    {% else %}
        <p class="inline-note">
            <a href="{% url 'login' %}?next={{ request.path }}">Login</a> to react, bookmark, or comment on this story.
        </p>
    {% endif %}
</section>

<section id="comments" class="card comments-card">
    <div class="comments-header">
        <h3>Comments</h3>
        <span class="comment-count">{{ comments_count }}</span>
    </div>
    {% if top_level_comments %}
        <ul class="comment-thread">
            {% for comment in top_level_comments %}
                <li class="comment-block" id="comment-{{ comment.id }}">
                    <span class="comment-avatar">{{ comment.user.first_name|default:comment.user.username|first|upper }}</span>
                    <div class="comment-main">
                        <header class="comment-meta">
                            <strong class="comment-author">{{ comment.user.username }}</strong>
                            <span class="comment-time">{{ comment.created_at|naturaltime }}</span>
                        </header>
                        <div class="comment-body">{{ comment.body|linebreaks }}</div>
                        <footer class="comment-footer">
                            <div class="comment-actions">
                                <button type="button" class="comment-pill-button is-icon comment-vote" data-direction="up" title="Upvote">
                                    <span class="icon" aria-hidden="true">↑</span>
                                    <span class="visually-hidden">Upvote</span>
                                </button>
                                <button type="button" class="comment-pill-button is-icon comment-vote" data-direction="down" title="Downvote">
                                    <span class="icon" aria-hidden="true">↓</span>
                                    <span class="visually-hidden">Downvote</span>
                                </button>
                                {% if user.is_authenticated %}
                                    <button type="button" class="comment-pill-button comment-reply-button" data-target="reply-form-{{ comment.id }}">
                                        <span class="icon" aria-hidden="true">↩</span>
                                        <span class="label">Reply</span>
                                    </button>
                                {% endif %}
                                {% if comment.can_delete_user %}
                                    <form method="post" class="comment-delete-form" data-confirm="Delete this comment?" action="{% url 'articles:comment_delete' article.slug comment.id %}">
                                        {% csrf_token %}
                                        <button type="submit" class="comment-pill-button is-icon comment-delete-button" title="Delete comment" aria-label="Delete comment">
                                            <svg class="icon" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                                                <path d="M9 10.5v6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                                                <path d="M15 10.5v6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                                                <path d="M5.5 7.5h13" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                                                <path d="M10.5 4.5h3a1 1 0 0 1 .98.79l.22 1.21H8.3l.22-1.21A1 1 0 0 1 9.5 4.5Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                                                <path d="M17.25 7.5v9.4c0 .88-.68 1.6-1.52 1.6H8.27c-.84 0-1.52-.72-1.52-1.6V7.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                        </footer>
                        {% if user.is_authenticated %}
                            <form class="reply-form hidden" id="reply-form-{{ comment.id }}" method="post" action="{% url 'articles:comment_create' article.slug %}">
                                {% csrf_token %}
                                <textarea name="body" rows="2" class="comment-textarea" placeholder="Reply to {{ comment.user.username }}"></textarea>
                                <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                <button type="submit" class="button secondary">Post reply</button>
                            </form>
                        {% endif %}
                        {% with replies=comment.cached_replies %}
                            {% if replies %}
                                <ul class="comment-children">
                                    {% for reply in replies %}
                                        <li class="comment-block" id="comment-{{ reply.id }}">
                                            <span class="comment-avatar small">{{ reply.user.first_name|default:reply.user.username|first|upper }}</span>
                                            <div class="comment-main">
                                                <header class="comment-meta">
                                                    <strong class="comment-author">{{ reply.user.username }}</strong>
                                                    <span class="comment-time">{{ reply.created_at|naturaltime }}</span>
                                                </header>
                                                <div class="comment-body">{{ reply.body|linebreaks }}</div>
                                                <footer class="comment-footer">
                                                    <div class="comment-actions">
                                                        {% if reply.can_delete_user %}
                                                            <form method="post" class="comment-delete-form" data-confirm="Delete this comment?" action="{% url 'articles:comment_delete' article.slug reply.id %}">
                                                                {% csrf_token %}
                                                                <button type="submit" class="comment-pill-button is-icon comment-delete-button" title="Delete comment" aria-label="Delete comment">
                                                                    <svg class="icon" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                                                                        <path d="M9 10.5v6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                                                                        <path d="M15 10.5v6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                                                                        <path d="M5.5 7.5h13" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                                                                        <path d="M10.5 4.5h3a1 1 0 0 1 .98.79l.22 1.21H8.3l.22-1.21A1 1 0 0 1 9.5 4.5Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                                                                        <path d="M17.25 7.5v9.4c0 .88-.68 1.6-1.52 1.6H8.27c-.84 0-1.52-.72-1.52-1.6V7.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                                                                    </svg>
                                                                </button>
                                                            </form>
                                                        {% endif %}
                                                    </div>
                                                </footer>
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        {% endwith %}
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="empty-state">No comments yet. Start the discussion!</p>
    {% endif %}
</section>
{% endblock %}


